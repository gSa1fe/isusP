import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase-server'

// ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
export const dynamic = 'force-dynamic'

export async function GET(request: Request) {
  const supabase = await createClient()
  
  // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

  try {
    // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á)
    const { data, error } = await supabase
      .from('reading_history')
      .select(`
        updated_at,
        episode_id,
        episodes!inner (
          episode_number,
          title,
          comics!inner (
            id,
            title,
            cover_image_url,
            genre
          )
        )
      `)
      .eq('user_id', user.id)
      .order('updated_at', { ascending: false })
      .limit(50) // ‡∏î‡∏∂‡∏á‡∏°‡∏≤ 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á

    if (error) throw error

    // 3. üü¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ (Group by Comic ID) ‡∏ó‡∏µ‡πà Server ‡πÄ‡∏•‡∏¢
    const uniqueHistoryMap = new Map()
    
    data.forEach((item: any) => {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô
        const comic = item.episodes?.comics
        if (!comic) return

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á updated_at ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏∑‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠)
        if (!uniqueHistoryMap.has(comic.id)) {
            uniqueHistoryMap.set(comic.id, item)
        }
    })

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    const uniqueHistory = Array.from(uniqueHistoryMap.values())

    return NextResponse.json({ history: uniqueHistory })

  } catch (error: any) {
    console.error("History API Error:", error.message)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}